# 消息设计 (Message Design)

Agent 与客户端（UI）之间通过 `Queue` 进行通信，消息格式为 JSON 字典。

## 1. 客户端 -> Agent (Client to Agent)
客户端发送的消息主要用于控制 Agent 的行为和响应权限请求。

**基本格式:**
```json
{
  "name": "CodeAgent",  // 给谁发送就填谁
  "type": "request",
  "content": "指令内容"
}
```

**指令内容 (content):**
- `approve`: 允许执行当前代码块。
- `deny`: 拒绝执行当前代码块。
- `stop_agent`: 停止整个 Agent 任务。
- `stop_code`: 停止当前正在执行的代码（中断执行）。

## 3. Agent -> 客户端 (Agent to Client)
Agent 发送的消息用于更新状态、流式传输 AI 回复、请求权限以及展示代码执行结果。

**基本格式:**
```json
{
  "name": "CodeAgent",
  "type": "消息类型",
  "content": "消息内容"
}
```

### 3.1 状态消息 (type: "status")
用于通知 UI 当前 Agent 的工作阶段。
- `[START]`: 任务开始。
- `[STOP]`: 任务结束（完成或被用户停止）。
- `[BLOCK{i}]`: 正在处理第 `i` 个代码块（准备执行）。

### 3.2 AI 内容流 (type: "ai_content")
用于流式展示 LLM 的思考和回复过程。
- `[BEGIN]`: 开始生成内容。
- `[END]`: 内容生成结束。
- `<text>`: AI 生成的文本片段（增量更新）。

### 3.3 权限请求 (type: "request")
当 Agent 解析出代码块并准备执行时，向 UI 请求权限。
- `[BLOCK{i}]need_permission`: 请求执行第 `i` 个代码块的权限。
  - UI 收到此消息后应显示“批准/拒绝”按钮。

### 3.4 代码执行输出 (type: "text" / "image/png" 等)
展示代码执行的实时输出。

- **文本输出 (type: "text"):**
  - `content`: 标准输出 (stdout) 或标准错误 (stderr) 的文本内容。

- **图片输出 (type: "image/png" / "image/jpeg"):**
  - *注意: 目前 `agent.py` 中图片处理逻辑被注释/跳过，需要修复才能正常接收图片。*
  - `content`: Base64 编码的图片数据。

- **其他类型:**
  - `html`: HTML 内容。
  - `javascript`: JS 代码。
  - `error`: 执行错误信息。

## 4. 交互流程示例 (Interaction Flow)

调用`CodeAgent.task("任务描述")`之后：

1. **任务开始**: Agent 发送 `status: [START]`。
2. **AI 思考**: Agent 发送 `ai_content: [BEGIN]`, 随后发送多条内容片段, 最后发送 `ai_content: [END]`。
3. **代码解析**: Agent 发现代码块。(Agent发现的代码块并不会传给客户端，客户端需要自己按顺序切分代码片段)
4. **请求权限**: Agent 发送 `status: [BLOCK0]`, `request: [BLOCK0]need_permission`。
5. **用户确认**: 客户端发送 `content: approve`。
6. **代码执行**: Agent 执行代码，持续发送 `type: text` (日志/结果)。
7. **执行完成**: Agent 继续下一轮或结束。
8. **任务结束**: Agent 发送 `status: [STOP]`。

## 5. TODO (Suggestions)
1. **修复图片传输**: base64太长，之后可以采取压缩方法
2. **结构化状态**: 目前的 `[START]` 等状态码混在 `content` 字符串中，建议后续优化为独立的枚举字段，方便前端解析。
3. **上下文未处理**
